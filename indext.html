<!DOCTYPE html>
<html lang="id">

<head>
  <title>Input Transaksi TarToast</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --primary-color: #FF6B35;
      --secondary-color: #FFD1B8;
      --accent-color: #004E89;
      --text-color: #333;
      --light-text: #666;
      --border-color: #ddd;
      --error-color: #e74c3c;
      --success-color: #2ecc71;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      background-color: var(--secondary-color);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: var(--text-color);
      line-height: 1.6;
      padding: 20px;
    }

    #form-container {
      max-width: 800px;
      margin: 0 auto;
      background-color: #ffffff;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }

    h2 {
      color: var(--primary-color);
      text-align: center;
      margin-bottom: 25px;
      font-size: 1.8rem;
    }

    h3 {
      color: var(--accent-color);
      margin: 20px 0 10px;
      font-size: 1.3rem;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: var(--light-text);
      font-weight: 500;
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      font-size: 16px;
      transition: border-color 0.3s;
    }

    .form-group input:focus,
    .form-group select:focus {
      border-color: var(--accent-color);
      outline: none;
      box-shadow: 0 0 0 2px rgba(0, 78, 137, 0.1);
    }

    .input-group {
      display: flex;
      gap: 15px;
      align-items: flex-end;
      margin-bottom: 15px;
    }

    .input-group .form-group {
      flex: 1;
      margin-bottom: 0;
    }

    .remove-btn {
      background-color: var(--error-color);
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      height: 46px;
      transition: background-color 0.3s;
    }

    .remove-btn:hover {
      background-color: #c0392b;
    }

    button {
      width: 100%;
      background-color: var(--accent-color);
      color: white;
      border: none;
      padding: 14px;
      border-radius: 6px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.3s, transform 0.2s;
      margin-top: 10px;
    }

    button:hover {
      background-color: #003d6b;
    }

    button:active {
      transform: scale(0.98);
    }

    .add-menu-btn {
      background-color: var(--primary-color);
      margin-bottom: 20px;
    }

    .add-menu-btn:hover {
      background-color: #e05a2a;
    }

    .receipt-preview {
      margin-top: 30px;
      border-top: 2px dashed var(--border-color);
      padding-top: 20px;
    }

    #receipt-content {
      background-color: #f9f9f9;
      padding: 15px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      white-space: pre-line;
    }

    #loading {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 9999;
      justify-content: center;
      align-items: center;
    }

    #loading div {
      background: #fff;
      padding: 25px 40px;
      border-radius: 10px;
      font-size: 18px;
      font-weight: 500;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      text-align: center;
    }

    .spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      border-top: 4px solid var(--accent-color);
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 15px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      #form-container {
        padding: 20px;
      }

      .input-group {
        flex-direction: column;
        gap: 10px;
      }

      .remove-btn {
        width: 100%;
        height: auto;
      }

      button {
        padding: 12px;
      }
    }

    @media (max-width: 480px) {
      body {
        padding: 10px;
      }

      #form-container {
        padding: 15px;
      }

      h2 {
        font-size: 1.5rem;
      }

      .form-group input,
      .form-group select {
        padding: 10px 12px;
        font-size: 15px;
      }
    }

    /* Print styles */
    @media print {
      body {
        background-color: white;
        padding: 0;
      }

      #form-container {
        box-shadow: none;
        border: none;
        padding: 0;
        max-width: 100%;
      }

      button, .remove-btn, .add-menu-btn {
        display: none !important;
      }

      .receipt-preview {
        border-top: none;
        padding-top: 0;
      }

      #receipt-content {
        background-color: white;
        padding: 0;
        font-size: 14px;
      }
    }
  </style>
</head>

<body>
  <div id="form-container">
    <h2>Transaksi Kasir TarToast</h2>
    <form id="kasirForm">
      <div class="form-group">
        <label for="nama_pelanggan">Nama Pelanggan</label>
        <input type="text" id="nama_pelanggan" name="nama_pelanggan" required placeholder="Masukkan nama pelanggan">
      </div>

      <div class="form-group">
        <label for="nama_kasir">Nama Kasir</label>
        <select id="nama_kasir" name="nama_kasir" required>
          <option value="">-- Pilih Kasir --</option>
          <option value="fathu">Fathu</option>
          <option value="aziz">Aziz</option>
          <option value="wibawa">Wibawa</option>
          <option value="mbuh">Mbuh</option>
        </select>
      </div>

      <div class="form-group">
        <label>Menu Pesanan</label>
        <div id="menu-container"></div>
        <button type="button" class="add-menu-btn" onclick="addMenu()">+ Tambah Menu</button>
      </div>

      <div class="input-group">
        <div class="form-group">
          <label for="total">Total Harga</label>
          <input type="text" id="total" name="total" readonly>
        </div>
      </div>

      <div class="input-group">
        <div class="form-group">
          <label for="bayar">Bayar (Rp)</label>
          <input type="number" id="bayar" name="bayar" min="0" required placeholder="Jumlah pembayaran">
        </div>
        <div class="form-group">
          <label for="kembali">Kembalian (Rp)</label>
          <input type="text" id="kembali" name="kembali" readonly>
        </div>
      </div>

      <button type="submit">Simpan dan Proses Transaksi</button>

      <div class="receipt-preview">
        <h3>Preview Struk</h3>
        <div id="receipt-content"></div>
      </div>
    </form>
  </div>

  <div id="loading">
    <div>
      <p>Menyimpan transaksi...</p>
      <div class="spinner"></div>
    </div>
  </div>

  <script>
    const menuList = [
      { nama: "Roti Bakar Keju", harga: 10000 },
      { nama: "Roti Bakar Coklat", harga: 15000 },
      { nama: "Roti Bakar Kacang", harga: 12000 },
      { nama: "Roti Bakar Special", harga: 18000 },
      { nama: "Teh Manis", harga: 5000 },
      { nama: "Kopi Susu", harga: 8000 },
      { nama: "Jus Alpukat", harga: 12000 },
      { nama: "Es Jeruk", harga: 7000 }
    ];

    // Initialize form with one menu item
    document.addEventListener('DOMContentLoaded', function() {
      addMenu();
      updateReceiptPreview();
      
      // Add event listeners
      document.getElementById("bayar").addEventListener("input", function() {
        calculateChange();
        updateReceiptPreview();
      });
      
      document.getElementById("nama_pelanggan").addEventListener("input", updateReceiptPreview);
      document.getElementById("nama_kasir").addEventListener("change", updateReceiptPreview);
    });

    function addMenu() {
      const container = document.getElementById("menu-container");
      const div = document.createElement("div");
      div.className = "input-group";
      div.innerHTML = `
        <div class="form-group">
          <select class="menu-select" required onchange="updateReceiptPreview()">
            <option value="">-- Pilih Menu --</option>
            ${menuList.map(menu => `<option value="${menu.nama}" data-harga="${menu.harga}">${menu.nama} (Rp ${formatRupiah(menu.harga)})</option>`).join('')}
          </select>
        </div>
        <div class="form-group">
          <input type="number" class="menu-jumlah" placeholder="Jumlah" min="1" required oninput="calculateTotal(); updateReceiptPreview()">
        </div>
        <button type="button" class="remove-btn" onclick="removeMenu(this)">Hapus</button>
      `;
      container.appendChild(div);

      // Trigger calculation after adding new menu
      calculateTotal();
      updateReceiptPreview();
    }

    function removeMenu(button) {
      const menuItem = button.parentNode;
      menuItem.remove();
      calculateTotal();
      updateReceiptPreview();
    }

    function formatRupiah(angka) {
      return parseFloat(angka).toLocaleString("id-ID");
    }

    function calculateTotal() {
      let total = 0;
      document.querySelectorAll("#menu-container .input-group").forEach(group => {
        const select = group.querySelector(".menu-select");
        const harga = parseFloat(select.selectedOptions[0]?.dataset.harga || 0);
        const jumlah = parseInt(group.querySelector(".menu-jumlah").value) || 0;
        total += harga * jumlah;
      });
      document.getElementById("total").value = formatRupiah(total);
      calculateChange();
    }

    function calculateChange() {
      const totalStr = document.getElementById("total").value.replace(/\./g, '').replace(',', '.');
      const total = parseFloat(totalStr) || 0;
      const bayar = parseFloat(document.getElementById("bayar").value) || 0;
      const kembali = bayar - total;
      document.getElementById("kembali").value = kembali >= 0 ? formatRupiah(kembali) : "0";
    }

    function updateReceiptPreview() {
      const namaPelanggan = document.getElementById("nama_pelanggan").value || "[Nama Pelanggan]";
      const namaKasir = document.getElementById("nama_kasir").value || "[Kasir]";
      const kasirText = document.getElementById("nama_kasir").options[document.getElementById("nama_kasir").selectedIndex]?.text || "[Kasir]";
      const now = new Date();
      const dateTime = now.toLocaleString('id-ID', {
        weekday: 'long',
        day: 'numeric',
        month: 'long',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
      
      let receiptText = `TARTOAST CAFE\n`;
      receiptText += `Jl. Contoh No. 123, Kota\n\n`;
      receiptText += `Tanggal: ${dateTime}\n`;
      receiptText += `Pelanggan: ${namaPelanggan}\n`;
      receiptText += `Kasir: ${kasirText}\n`;
      receiptText += `========================\n`;
      
      // Add menu items
      let total = 0;
      document.querySelectorAll("#menu-container .input-group").forEach(group => {
        const select = group.querySelector(".menu-select");
        const menuName = select.value || "[Menu]";
        const harga = parseFloat(select.selectedOptions[0]?.dataset.harga || 0);
        const jumlah = parseInt(group.querySelector(".menu-jumlah").value) || 0;
        const subtotal = harga * jumlah;
        
        if (menuName && jumlah > 0) {
          receiptText += `${menuName.padEnd(20, ' ')} ${jumlah}x Rp ${formatRupiah(harga)}\n`;
          receiptText += `                    Rp ${formatRupiah(subtotal)}\n`;
          total += subtotal;
        }
      });
      
      receiptText += `========================\n`;
      receiptText += `TOTAL:      Rp ${formatRupiah(total)}\n`;
      
      const bayar = parseFloat(document.getElementById("bayar").value) || 0;
      if (bayar > 0) {
        receiptText += `BAYAR:      Rp ${formatRupiah(bayar)}\n`;
        const kembali = bayar - total;
        receiptText += `KEMBALI:    Rp ${formatRupiah(kembali >= 0 ? kembali : 0)}\n`;
      }
      
      receiptText += `========================\n`;
      receiptText += `Terima kasih telah berkunjung\n`;
      receiptText += `Silakan datang kembali!\n`;
      
      document.getElementById("receipt-content").textContent = receiptText;
    }

    function showLoading() {
      document.getElementById("loading").style.display = "flex";
    }

    function hideLoading() {
      document.getElementById("loading").style.display = "none";
    }

    document.getElementById("kasirForm").addEventListener("submit", function (e) {
      e.preventDefault();

      // Validate kasir selection
      const kasir = document.getElementById("nama_kasir").value;
      if (!kasir) {
        alert("Silakan pilih nama kasir.");
        return;
      }

      // Validate menu items
      const menuItems = [];
      let valid = true;
      let hasItems = false;

      document.querySelectorAll("#menu-container .input-group").forEach(group => {
        const select = group.querySelector(".menu-select");
        const jumlah = group.querySelector(".menu-jumlah").value;
        
        if (select.value && jumlah > 0) {
          hasItems = true;
          menuItems.push({
            nama: select.value,
            harga: parseFloat(select.selectedOptions[0].dataset.harga),
            jumlah: parseInt(jumlah)
          });
        } else if (select.value || jumlah > 0) {
          valid = false;
        }
      });

      if (!hasItems || !valid) {
        alert("Minimal satu menu valid harus dipilih dan jumlah harus diisi.");
        return;
      }

      // Validate payment
      const totalStr = document.getElementById("total").value.replace(/\./g, '').replace(',', '.');
      const total = parseFloat(totalStr) || 0;
      const bayar = parseFloat(document.getElementById("bayar").value) || 0;
      
      if (bayar < total) {
        alert("Jumlah pembayaran kurang dari total harga.");
        return;
      }

      // Prepare form data
      const formData = new FormData();
      formData.append("nama_pelanggan", document.getElementById("nama_pelanggan").value);
      formData.append("nama_kasir", kasir);
      formData.append("total", total);
      formData.append("bayar", bayar);
      formData.append("kembali", bayar - total);
      formData.append("menu_list", JSON.stringify(menuItems));

      showLoading();

      // Send data to Google Apps Script
      fetch("https://script.google.com/macros/s/AKfycbypLgl92sfguQ1hh5DBEsBy6mSSwAElegtgqY-Jvk8r1z4tYUJBTlnqMFECj1uSxNjcGw/exec", {
        method: "POST",
        body: formData
      })
        .then(response => response.json())
        .then(data => {
          hideLoading();
          if (data.status === "success") {
            alert("Transaksi berhasil disimpan!\nJangan lupa laporan setelah selesai shift ya.");
            
            // Option to print receipt
            if (confirm("Cetak struk sekarang?")) {
              window.print();
            }
            
            location.reload();
          } else {
            alert("Gagal menyimpan transaksi: " + (data.message || "Cek koneksi internet Anda"));
          }
        })
        .catch(error => {
          hideLoading();
          alert("Error: " + error.message);
          console.error("Error:", error);
        });
    });
  </script>
</body>

</html>
